<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ê–Ω—Å–∞–º–±–ª–∏ –º–æ–¥–µ–ª–µ–π: Random Forest –∏ Boosting</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 900px;
      margin: 20px auto;
      padding: 0 15px;
      line-height: 1.4;
    }
    h1, h2 { text-align: center; }
    #canvas { display: block; margin: 0 auto 20px; border: 1px solid #ccc; background: #fff; }
    .controls { text-align: center; margin-bottom: 15px; }
    .controls button { margin: 0 8px; padding: 6px 12px; font-size: 1rem; }
    #log { background: #f5f5f5; padding: 10px; border-radius: 4px; border: 1px solid #ddd; 
           font-family: monospace; white-space: pre-line; max-height: 200px; overflow-y: auto; }
  </style>
</head>
<body>

  <h1>–ê–Ω—Å–∞–º–±–ª–∏ –º–æ–¥–µ–ª–µ–π ¬´–¥–ª—è –¥—É—Ä–∞—á–∫–æ–≤¬ª</h1>
  <p style="text-align:center;">–ú–Ω–æ–≥–æ —Å–ª–∞–±—ã—Ö —ç–∫—Å–ø–µ—Ä—Ç–æ–≤ ‚Üí –≤–º–µ—Å—Ç–µ –æ–Ω–∏ —Å–∏–ª—å–Ω–µ–µ! üßë‚Äç‚öñÔ∏èüë®‚Äçüè´üë©‚Äçüî¨üë®‚Äçüîß ‚ûî üß†</p>

  <h2>1. Random Forest (3 —Ä–µ—à–µ–Ω–∏—è ¬´–ø–µ–Ω—å–∫–∞¬ª) üå≥üå≥üå≥</h2>
  <canvas id="canvas" width="600" height="400"></canvas>
  <div class="controls">
    <button id="gen">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
    <button id="rfStep" disabled>–®–∞–≥ RF: –¥–æ–±–∞–≤–∏—Ç—å "–ø–µ–Ω—å"</button>
    <button id="rfVote" disabled>–ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ</button>
    <button id="rfReset" disabled>–°–±—Ä–æ—Å RF</button>
  </div>
  <div id="log">–ñ—É—Ä–Ω–∞–ª RF: –∂–º–∏ ¬´–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ¬ª.</div>

  <h2>2. Gradient Boosting (–ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è) üö≤</h2>
  <canvas id="canvas2" width="600" height="400"></canvas>
  <div class="controls">
    <button id="gbStep1" disabled>–®–∞–≥ GB: –ø–µ—Ä–≤—ã–π "–ø–µ–Ω—å"</button>
    <button id="gbStep2" disabled>–®–∞–≥ GB: –≤—Ç–æ—Ä–æ–π "–ø–µ–Ω—å"</button>
    <button id="gbStep3" disabled>–®–∞–≥ GB: —Ç—Ä–µ—Ç–∏–π "–ø–µ–Ω—å"</button>
    <button id="gbReset" disabled>–°–±—Ä–æ—Å GB</button>
  </div>
  <div id="log2">–ñ—É—Ä–Ω–∞–ª GB: —Å–ø–µ—Ä–≤–∞ –∑–∞–ø—É—Å—Ç–∏ RF, —Ç–æ–≥–¥–∞ –º–æ–∂–Ω–æ –Ω–∞—á–∞—Ç—å GB.</div>

<script>
  // –£—Ç–∏–ª–∏—Ç—ã
  function rand(a,b){return Math.random()*(b-a)+a;}
  function sign(x){return x>=0?1:0;}

  // –û–±—â–∏–µ –¥–∞–Ω–Ω—ã–µ
  const N = 60;
  let data = [];   // {x,y,label}
  const canvas = document.getElementById('canvas'), ctx = canvas.getContext('2d');
  const log = document.getElementById('log');
  // RF
  let rfStumps = [], rfPreds = []; // each stump: {axis:'x'|'y', thresh}, rfPreds: [ [pred by stump0,...], ... ]
  // GB
  const canvas2 = document.getElementById('canvas2'), ctx2 = canvas2.getContext('2d');
  const log2 = document.getElementById('log2');
  let residuals=[], gbModels=[]; // gbModels: same stump structure, residuals updated

  // –†–∏—Å—É–µ–º —Ç–æ—á–∫–∏, —Ü–≤–µ—Ç –ø–æ –º–µ—Ç–∫–µ
  function drawData(ctx, arr, preds=null){
    ctx.clearRect(0,0,600,400);
    arr.forEach((p,i)=>{
      const c0 = p.label? '#e63946':'#2a9d8f';
      const c = preds ? (preds[i]? '#e63946':'#2a9d8f') : c0;
      ctx.fillStyle = c;
      ctx.beginPath();
      ctx.arc(p.x,p.y,5,0,2*Math.PI);
      ctx.fill();
    });
  }

  // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö: 2 –∫–ª–∞—Å—Ç–µ—Ä–∞
  document.getElementById('gen').onclick = ()=>{
    data = [];
    // –∫–ª–∞—Å—Ç–µ—Ä 0: —Å–ª–µ–≤–∞
    for(let i=0;i<N/2;i++){
      data.push({x:rand(20,280), y:rand(20,380), label:0});
    }
    // –∫–ª–∞—Å—Ç–µ—Ä 1: —Å–ø—Ä–∞–≤–∞
    for(let i=0;i<N/2;i++){
      data.push({x:rand(320,580), y:rand(20,380), label:1});
    }
    rfStumps=[]; rfPreds=[];
    drawData(ctx, data);
    log.textContent = `–î–∞–Ω–Ω—ã–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã: ${N} —Ç–æ—á–µ–∫, –¥–≤–∞ –∫–ª–∞—Å—Ç–µ—Ä–∞.\n`+
                      `–®–∞–≥ RF: –Ω–∞–∂–º–∏ "–®–∞–≥ RF: –¥–æ–±–∞–≤–∏—Ç—å '–ø–µ–Ω—å'".`;
    document.getElementById('rfStep').disabled = false;
    document.getElementById('rfVote').disabled = true;
    document.getElementById('rfReset').disabled = false;
    // GB —Ç–æ–∂–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º
    residuals = data.map(p=> p.label - 0.5); // –Ω–∞—á–∞–ª—å–Ω—ã–µ residuals –¥–ª—è GB
    gbModels = [];
    drawData(ctx2, data);
    log2.textContent = '–ñ—É—Ä–Ω–∞–ª GB: —Å–ø–µ—Ä–≤–∞ RF (–¥–µ—Ä–µ–≤—å—è) –Ω–µ –≤–ª–∏—è–µ—Ç –Ω–∞ GB, –Ω–æ –º–æ–∂–Ω–æ —Å—Ä–∞–∑—É –Ω–∞–∂–∞—Ç—å "GB Step1".';
    document.getElementById('gbStep1').disabled = false;
    document.getElementById('gbStep2').disabled = true;
    document.getElementById('gbStep3').disabled = true;
    document.getElementById('gbReset').disabled = false;
  };

  // –°–æ–∑–¥–∞—Ç—å –ø—Ä–æ—Å—Ç–æ–π stump: –∏—â–µ–º –ª—É—á—à–µ–µ –ø–æ—Ä–æ–≥–æ–≤–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –ø–æ x –∏–ª–∏ y
  function fitStump(resids){
    // –ø—Ä–æ–±—É–µ–º axis x –∏ y, thresholds = —Å–µ—Ä–µ–¥–∏–Ω—ã —Å–æ—Å–µ–¥–Ω–∏—Ö sorted
    let best = {axis:'x', thresh:0, err:Infinity, predL:0, predR:1};
    ['x','y'].forEach(axis=>{
      // —Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ axis
      const sorted = data.slice().sort((a,b)=>a[axis]-b[axis]);
      for(let i=1;i<sorted.length;i++){
        const t = (sorted[i-1][axis]+sorted[i][axis])/2;
        // –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ—Ä–æ–≥
        let err = 0;
        sorted.forEach(p=>{
          const pred = p[axis]<t? 0:1;
          // –¥–ª—è RF stump –±—É–¥–µ—Ç –æ–±—ã—á–Ω–∞—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è, –¥–ª—è GB stump –±—É–¥–µ—Ç –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ residual sign
          // –∑–¥–µ—Å—å –¥–ª—è GB residuals –º—ã —Ö–æ—Ç–∏–º –ø—Ä–µ–¥—Å–∫–∞–∑–∞—Ç—å residuals (regressor), –Ω–æ —É–ø—Ä–æ—â–∞–µ–º:
          err += Math.pow((pred - (resids? resids[data.indexOf(p)] : p.label)), 2);
        });
        if(err<best.err){
          best = {axis, thresh: t, err};
        }
      }
    });
    return best;
  }

  // RF: –¥–æ–±–∞–≤–ª—è–µ–º random stump (–ø—Ä–æ—Å—Ç–æ random axis+threshold)
  document.getElementById('rfStep').onclick = ()=>{
    const axis = Math.random()<0.5?'x':'y';
    const thresh = rand(50,550);
    const stump = {axis, thresh};
    rfStumps.push(stump);
    // –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è
    const preds = data.map(p=> p[axis]<thresh?0:1);
    rfPreds.push(preds);
    drawData(ctx, data);
    log.textContent += 
      `\n–î–µ—Ä–µ–≤–æ ${rfStumps.length}: stump –ø–æ ${axis.toUpperCase()}<${thresh.toFixed(1)} `+
      `(–ø—Ä–µ–¥—Å–∫–∞–∑–∞–ª–∏ [${preds.filter(x=>x==1).length} –µ–¥–∏–Ω–∏—Ü])`;
    if(rfStumps.length>=3){
      document.getElementById('rfStep').disabled = true;
      document.getElementById('rfVote').disabled = false;
      log.textContent += `\n\n–¢–µ–ø–µ—Ä—å –Ω–∞–∂–º–∏ "–ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ" ‚Äî Majority Vote.`;
    }
  };

  // RF: majority vote
  document.getElementById('rfVote').onclick = ()=>{
    // –¥–ª—è –∫–∞–∂–¥–æ–π —Ç–æ—á–∫–∏ —Å—á–∏—Ç–∞–µ–º —Å—É–º–º—É –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π
    const final = data.map((_,i)=>{
      const sum = rfPreds.reduce((s,p)=>s+p[i],0);
      return sum>=Math.ceil(rfStumps.length/2)?1:0;
    });
    drawData(ctx, data, final);
    log.textContent += `\n\n–ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ. –û—à–∏–±–∫–∞ RF: `+
      `${final.filter((p,i)=>p!==data[i].label).length}/${N} –æ—à–∏–±–æ–∫.`;
    document.getElementById('rfVote').disabled = true;
  };

  document.getElementById('rfReset').onclick = ()=>{
    ctx.clearRect(0,0,canvas.width,canvas.height);
    log.textContent = '–ñ—É—Ä–Ω–∞–ª RF: –∂–º–∏ ¬´–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ¬ª.';
    rfStumps=[]; rfPreds=[];
    document.getElementById('rfStep').disabled = true;
    document.getElementById('rfVote').disabled = true;
    document.getElementById('rfReset').disabled = true;
  };

  // === Gradient Boosting Demo ===

  // –û–¥–∏–Ω —à–∞–≥ –±—É—Å—Ç–∏–Ω–≥–∞: fit stump –Ω–∞ residuals
  function gbStep(){
    const stump = fitStump(residuals);
    gbModels.push(stump);
    // –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ stump
    const preds = data.map(p=> p[stump.axis] < stump.thresh? 0:1);
    // –æ–±–Ω–æ–≤–ª—è–µ–º residuals (—É–ø—Ä–æ—â–∞–µ–º –¥–ª—è –¥–µ–º–æ): residual = residual - learning_rate*(preds - 0.5)
    const lr = 0.5;
    residuals = residuals.map((r,i)=> r - lr*(preds[i]-0.5));
    // –∏—Ç–æ–≥–æ–≤–∞—è –∞–≥—Ä–µ–≥–∞—Ü–∏—è: sum(preds_i*lr)
    const agg = data.map((_,i)=>{
      return gbModels.reduce((s,m,j)=>{
        const pr = data[i][m.axis]<m.thresh?0:1;
        return s + lr*(pr-0.5); // —Ü–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –≤–æ–∫—Ä—É–≥ 0
      },0) >= 0? 1:0;
    });
    return {stump, preds, agg};
  }

  document.getElementById('gbStep1').onclick = ()=>{
    const {stump,preds,agg} = gbStep();
    drawData(ctx2,data,agg);
    log2.textContent += 
      `–®–∞–≥ 1: –ø–æ—Å—Ç—Ä–æ–∏–ª–∏ stump –ø–æ ${stump.axis}<${stump.thresh.toFixed(1)}> `+
      `(err‚âà${stump.err.toFixed(1)})\n`+
      `  + –∞–≥—Ä–µ–≥–∞—Ü–∏—è ‚Üí –æ—à–∏–±–æ–∫ ${agg.filter((p,i)=>p!==data[i].label).length}/${N}\n\n`;
    document.getElementById('gbStep1').disabled = true;
    document.getElementById('gbStep2').disabled = false;
  };
  document.getElementById('gbStep2').onclick = ()=>{
    const {stump,preds,agg} = gbStep();
    drawData(ctx2,data,agg);
    log2.textContent += 
      `–®–∞–≥ 2: –¥–æ–±–∞–≤–∏–ª–∏ stump –ø–æ ${stump.axis}<${stump.thresh.toFixed(1)}> `+
      `(err‚âà${stump.err.toFixed(1)})\n`+
      `  + –∞–≥—Ä–µ–≥–∞—Ü–∏—è ‚Üí –æ—à–∏–±–æ–∫ ${agg.filter((p,i)=>p!==data[i].label).length}/${N}\n\n`;
    document.getElementById('gbStep2').disabled = true;
    document.getElementById('gbStep3').disabled = false;
  };
  document.getElementById('gbStep3').onclick = ()=>{
    const {stump,preds,agg} = gbStep();
    drawData(ctx2,data,agg);
    log2.textContent += 
      `–®–∞–≥ 3: –¥–æ–±–∞–≤–∏–ª–∏ stump –ø–æ ${stump.axis}<${stump.thresh.toFixed(1)}> `+
      `(err‚âà${stump.err.toFixed(1)})\n`+
      `  + —Ñ–∏–Ω–∞–ª—å–Ω–∞—è –∞–≥—Ä–µ–≥–∞—Ü–∏—è ‚Üí –æ—à–∏–±–æ–∫ ${agg.filter((p,i)=>p!==data[i].label).length}/${N}\n\n`+
      `GB –∑–∞–≤–µ—Ä—à—ë–Ω: –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ –∏—Å–ø—Ä–∞–≤–ª—è–ª–∏ –æ—à–∏–±–∫–∏!`;
    document.getElementById('gbStep3').disabled = true;
  };
  document.getElementById('gbReset').onclick = ()=>{
    ctx2.clearRect(0,0,canvas2.width,canvas2.height);
    log2.textContent = '–ñ—É—Ä–Ω–∞–ª GB: —Å–ø–µ—Ä–≤–∞ RF (–∏–ª–∏ —Å—Ä–∞–∑—É) ‚Äî –º–æ–∂–Ω–æ –Ω–∞–∂–∞—Ç—å "GB Step1".';
    residuals = data.map(p=>p.label - 0.5);
    gbModels = [];
    document.getElementById('gbStep1').disabled = false;
    document.getElementById('gbStep2').disabled = true;
    document.getElementById('gbStep3').disabled = true;
    document.getElementById('gbReset').disabled = false;
  };
</script>

</body>
</html>
