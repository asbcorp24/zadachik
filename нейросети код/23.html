<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Демо: Оптимизаторы в нейросетях</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 30px auto;
      padding: 0 15px;
      line-height: 1.5;
    }
    h1 { text-align: center; }
    .controls {
      margin: 20px 0;
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
    }
    .controls label {
      font-size: 0.95rem;
    }
    .controls input, .controls select {
      font-size: 1rem;
      padding: 4px 6px;
      width: 80px;
    }
    .controls button {
      font-size: 1rem;
      padding: 6px 12px;
    }
    #plot {
      display: block;
      margin: 0 auto;
      background: #fafafa;
      border: 1px solid #ccc;
    }
    #info {
      margin-top: 20px;
      background: #f5f5f5;
      padding: 12px;
      border-radius: 4px;
      font-family: monospace;
      white-space: pre-line;
    }
  </style>
</head>
<body>

  <h1>Оптимизаторы: SGD vs RMSprop vs Adam</h1>

  <p>Ошибка задаём простой функцией <strong>f(x) = x²</strong>. Минимум — в точке x = 0.</p>

  <div class="controls">
    <label>Стартовое x:<br><input type="number" id="initX" value="4" step="0.1"></label>
    <label>Базовый lr α:<br><input type="number" id="lr" value="0.1" step="0.01"></label>
    <label>Оптимизатор:<br>
      <select id="optSelect">
        <option>SGD</option>
        <option>RMSprop</option>
        <option>Adam</option>
      </select>
    </label>
    <div id="hyperparams">
      <!-- гиперпараметры RMSprop/Adam появятся здесь -->
    </div>
    <button id="startBtn">Начать</button>
    <button id="nextBtn" disabled>След. шаг</button>
    <button id="resetBtn" disabled>Сбросить</button>
  </div>

  <canvas id="plot" width="700" height="300"></canvas>
  <div id="info">Нажми «Начать», чтобы увидеть первый шаг.</div>

  <script>
    const canvas = document.getElementById('plot');
    const ctx    = canvas.getContext('2d');
    const info   = document.getElementById('info');
    const initXIn= document.getElementById('initX');
    const lrIn   = document.getElementById('lr');
    const optSel = document.getElementById('optSelect');
    const hypDiv = document.getElementById('hyperparams');
    const startBtn = document.getElementById('startBtn');
    const nextBtn  = document.getElementById('nextBtn');
    const resetBtn = document.getElementById('resetBtn');

    let x, lr, optimizer, step;
    // RMSprop
    let eg2;
    // Adam
    let m, v, t;

    // Отрисовка параболы f(x)=x^2
    function drawPlot() {
      const W = canvas.width, H = canvas.height;
      ctx.clearRect(0,0,W,H);
      // оси
      ctx.strokeStyle = '#888';
      ctx.beginPath();
      ctx.moveTo(0,H/2); ctx.lineTo(W,H/2);
      ctx.moveTo(W/2,0); ctx.lineTo(W/2,H);
      ctx.stroke();
      // парабола
      ctx.strokeStyle = '#007ACC';
      ctx.beginPath();
      for(let px=0;px<=W;px++){
        const xv = (px/W)*10 - 5;     // -5..5
        const yv = xv*xv;             // 0..25
        const py = H/2 - (yv/25)*(H/2);
        px===0? ctx.moveTo(px,py): ctx.lineTo(px,py);
      }
      ctx.stroke();
    }
    function xToPx(xv) { return ((xv+5)/10)*canvas.width; }
    function yToPy(yv) { return canvas.height/2 - (yv/25)*(canvas.height/2); }
    function drawPoint(xv, color='#E63946'){
      const px = xToPx(xv), py = yToPy(xv*xv);
      ctx.fillStyle = color;
      ctx.beginPath();
      ctx.arc(px,py,6,0,2*Math.PI);
      ctx.fill();
    }

    function showHyperparams(){
      const opt = optSel.value;
      hypDiv.innerHTML = '';
      if(opt==='RMSprop'){
        hypDiv.innerHTML = `
          <label>β₂:<br><input type="number" id="beta2" value="0.9" step="0.01"></label>
          <label>ε:<br><input type="number" id="eps" value="1e-8" step="1e-9"></label>
        `;
      } else if(opt==='Adam'){
        hypDiv.innerHTML = `
          <label>β₁:<br><input type="number" id="beta1" value="0.9" step="0.01"></label>
          <label>β₂:<br><input type="number" id="beta2" value="0.999" step="0.001"></label>
          <label>ε:<br><input type="number" id="eps" value="1e-8" step="1e-9"></label>
        `;
      }
    }

    optSel.addEventListener('change', showHyperparams);
    showHyperparams();

    function startDemo(){
      x = parseFloat(initXIn.value);
      lr= parseFloat(lrIn.value);
      optimizer = optSel.value;
      step = 0;
      // сброс сост. RMSprop/Adam
      eg2 = 0;
      m = 0; v = 0; t = 0;
      // если нужны гиперпараметры – считать позже
      drawPlot();
      drawPoint(x,'#E63946');
      info.textContent = `Шаг ${step} — старт:
x = ${x.toFixed(4)}, f(x)= ${ (x*x).toFixed(4) }
Оптимизатор: ${optimizer}

Нажми «След. шаг»`;
      startBtn.disabled = true;
      nextBtn.disabled = false;
      resetBtn.disabled = false;
    }

    function nextStep(){
      step++;
      const grad = 2*x;
      let details = `Шаг ${step} — ${optimizer}:\n`;
      let xNew, lrAdj, beta1, beta2, eps, mHat, vHat;

      if(optimizer==='SGD'){
        details += `град = 2·x = ${grad.toFixed(4)}\n`;
        details += `lr = ${lr}\n`;
        xNew = x - lr*grad;
        details += `x_new = x - lr·град = ${x.toFixed(4)} - ${lr}·${grad.toFixed(4)} = ${xNew.toFixed(4)}\n`;
      }
      else if(optimizer==='RMSprop'){
        beta2 = parseFloat(document.getElementById('beta2').value);
        eps   = parseFloat(document.getElementById('eps').value);
        // обновляем сглаженный квадрат градиента
        eg2 = beta2*eg2 + (1-beta2)*grad*grad;
        lrAdj = lr / (Math.sqrt(eg2) + eps);
        details += `град = 2·x = ${grad.toFixed(4)}\n`;
        details += `β₂ = ${beta2}, ε = ${eps}\n`;
        details += `E[g²] = ${eg2.toFixed(6)}\n`;
        details += `lr_adj = lr / (√E[g²]+ε) = ${lr.toFixed(4)} / (√${eg2.toFixed(6)}+${eps}) = ${lrAdj.toFixed(4)}\n`;
        xNew = x - lrAdj*grad;
        details += `x_new = ${x.toFixed(4)} - ${lrAdj.toFixed(4)}·${grad.toFixed(4)} = ${xNew.toFixed(4)}\n`;
      }
      else if(optimizer==='Adam'){
        beta1 = parseFloat(document.getElementById('beta1').value);
        beta2 = parseFloat(document.getElementById('beta2').value);
        eps   = parseFloat(document.getElementById('eps').value);
        t++;
        m = beta1*m + (1-beta1)*grad;
        v = beta2*v + (1-beta2)*grad*grad;
        mHat = m/(1-Math.pow(beta1,t));
        vHat = v/(1-Math.pow(beta2,t));
        details += `град = 2·x = ${grad.toFixed(4)}\n`;
        details += `β₁=${beta1}, β₂=${beta2}, ε=${eps}\n`;
        details += `m = ${m.toFixed(6)}, v = ${v.toFixed(6)}\n`;
        details += `m̂ = m/(1-β₁ᵗ) = ${mHat.toFixed(6)}\n`;
        details += `v̂ = v/(1-β₂ᵗ) = ${vHat.toFixed(6)}\n`;
        lrAdj = lr / (Math.sqrt(vHat) + eps);
        details += `lr_adj = lr / (√v̂+ε) = ${lr.toFixed(4)}/${Math.sqrt(vHat).toFixed(4)}+${eps} = ${lrAdj.toFixed(4)}\n`;
        xNew = x - lrAdj*mHat;
        details += `x_new = ${x.toFixed(4)} - ${lrAdj.toFixed(4)}·${mHat.toFixed(4)} = ${xNew.toFixed(4)}\n`;
      }

      // отрисовка
      drawPlot();
      drawPoint(x,'#999');       // старая серая
      drawPoint(xNew,'#E63946'); // новая красная

      info.textContent = details;
      x = xNew;
    }

    function resetDemo(){
      ctx.clearRect(0,0,canvas.width,canvas.height);
      drawPlot();
      info.textContent = 'Нажми «Начать», чтобы увидеть первый шаг.';
      startBtn.disabled = false;
      nextBtn.disabled = true;
      resetBtn.disabled = true;
    }

    startBtn.onclick = startDemo;
    nextBtn.onclick  = nextStep;
    resetBtn.onclick = resetDemo;

    // начальная отрисовка
    drawPlot();
  </script>

</body>
</html>
